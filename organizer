#!/usr/bin/env bash

set -euo pipefail
trap 'echo "Error on line $LINENO"' ERR

# this variable is used to determine the directory to operate on
# if user specifies one it will be that or the current one
dir_to_operate_on="./"
dot_dir="."
# this is used to determine whether the user asked for verbose mode with -v option
verboseMode=false
# this is used to determine if user specified dry_run option or not
dry_run=false

while getopts :nvd: opt; do
  case "$opt" in
  d)
    # if user specifies directory, then operate on that dir
    if [[ -d "$OPTARG" && $OPTARG == "$dot_dir" ]]; then
      dir_to_operate_on="./"
    elif [[ -d "$OPTARG" ]]; then
      dir_to_operate_on="$OPTARG"
      if [[ "${dir_to_operate_on: -1:1}" == / ]]; then
        dir_to_operate_on="$OPTARG"
      else
        #  echo "no ther is no slash"
        dir_to_operate_on="$OPTARG"
        dir_to_operate_on+="/"
      fi
    else
      echo "invalid directory"
      exit 10
    fi
    ;;
  n)
    dry_run=true
    ;;
  v)
    verboseMode=true
    ;;
  :)
    echo "argument is needed for option -$OPTARG."
    exit 1
    ;;
  *)
    exit 1
    ;;
  esac
done

ensure_dir_and_move() {
  declare -n dir=$1
  declare -n itemTobeMoved=$2
  if [[ "$dry_run" == true ]]; then
    if [[ -d $dir_to_operate_on$dir ]]; then
      echo " would move $itemTobeMoved" "-> $dir_to_operate_on$dir"
    else
      #echo "would  create directory $dir_to_operate_on$dir"
      echo " would move $itemTobeMoved" "-> $dir_to_operate_on$dir"
    fi
    return
  fi

  if [[ $verboseMode == false ]]; then
    if [[ -d $dir_to_operate_on$dir ]]; then
      mv "$itemTobeMoved" "$dir_to_operate_on$dir"
    else
      mkdir "$dir_to_operate_on$dir"
      mv "$itemTobeMoved" "$dir_to_operate_on$dir"
    fi
  else
    # user asked for verbose mode
    if [[ -d $dir_to_operate_on$dir ]]; then
      mv "$itemTobeMoved" "$dir_to_operate_on$dir"
      echo "move $itemTobeMoved" "->" "$dir_to_operate_on$dir"
    else
      mkdir "$dir_to_operate_on$dir"
      echo "mkdir: created directory $dir_to_operate_on$dir"
      mv "$itemTobeMoved" "$dir_to_operate_on$dir"
      echo "move $itemTobeMoved" "->" "$dir_to_operate_on$dir"
    fi
  fi
}

organize_files_by_type() {

  for extension in "$dir_to_operate_on"*; do
    if [[ -d $extension ]]; then
      continue
    fi
    case "${extension}" in
    # Documents
    *.pdf | *.doc | *.docx | *.txt | *.rtf | *.odt | *.md)
      local category="Documents"
      ensure_dir_and_move category extension

      ;;
    *.xls | *.xlsx | *.csv | *.ods)
      local category="Spreadsheets"
      ensure_dir_and_move category extension
      ;;
    *.ppt | *.pptx | *.odp)
      local category="Presentations"
      ensure_dir_and_move category extension
      ;;

    # Images
    *.jpg | *.jpeg | *.png | *.gif | *.bmp | *.svg | *.webp | *.ico | *.tiff | *.tif)
      local category="Images"
      ensure_dir_and_move category extension
      ;;

    # Videos
    *.avi | *.mkv | *.mov | *.wmv | *.flv | *.webm | *.m4v | *.mpg | *.mpeg | *.mp4)
      local category="Videos"
      ensure_dir_and_move category extension
      ;;

    # Audio
    *.mp3 | *.wav | *.flac | *.aac | *.ogg | *.m4a | *.wma | *.opus)
      local category="Audio"
      ensure_dir_and_move category extension
      ;;

    # Archives
    *.zip | *.rar | *.tar | *.gz | *.7z | *.bz2 | *.xz | *.tgz)
      local category="Archives"
      ensure_dir_and_move category extension
      ;;

    # Code
    *.py | *.java | *.cpp | *.c | *.h | *.js | *.ts | *.html | *.css | *.php | *.rb | *.go | *.rs | *.swift)
      local category="Code"
      ensure_dir_and_move category extension
      ;;

    # Executables
    *.exe | *.app | *.deb | *.rpm | *.apk | *.dmg | *.msi | *.sh)
      local category="Executables"
      ensure_dir_and_move category extension
      ;;

    # Default
    *)
      local category="Other"
      ensure_dir_and_move category extension
      ;;
    esac
  done
}

organize_files_by_type
